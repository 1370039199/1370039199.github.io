<!DOCTYPE html>
<html lang="zh-CN">
<head><!-- hexo injector head_begin start -->
        <link rel="preconnect" href="undefined" crossorigin="">
        <link rel="preconnect" href="https://cdn.staticfile.org" crossorigin="">
        <link rel="preconnect" href="https://cravatar.cn" crossorigin=""><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#e7ddc8" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#181c27" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/resources/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/resources/favicon/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/resources/favicon/favicon.ico">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hyh.cool","root":"/","images":"/resources/img/","scheme":"Gemini","darkmode":true,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":true,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/config.min.js"></script>

    <meta name="description" content="记录本人在使用Semtech公司的SX1262芯片所遇到的问题以及调试的一些经验😊">
<meta property="og:type" content="article">
<meta property="og:title" content="SX1261&#x2F;2芯片学习笔记">
<meta property="og:url" content="https://hyh.cool/post/18/index.html">
<meta property="og:site_name" content="hyh&#39;s Blog">
<meta property="og:description" content="记录本人在使用Semtech公司的SX1262芯片所遇到的问题以及调试的一些经验😊">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081549710.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081654895.png">
<meta property="og:image" content="https://hyh1370039199.oss-cn-chengdu.aliyuncs.com/img/img/20220316151735.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081736102.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091552944.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081933360.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081951587.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081958611.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082019176.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082028349.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082119609.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082127155.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082222500.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082158878.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082159872.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082202252.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082204769.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082221939.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090918020.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090923777.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090929165.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090934972.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091029524.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091044770.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091108439.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091143039.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091402631.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091412623.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091415680.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091423666.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091430107.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091435678.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091512061.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091648276.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091726754.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092024938.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092030969.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091822473.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091937839.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091953209.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091956020.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091959515.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092106654.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092112970.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092122212.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092101706.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092118108.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092118580.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092045923.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046557.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046689.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046502.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092048034.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092054205.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092116441.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092135929.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092138347.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092132496.png">
<meta property="og:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092134284.png">
<meta property="article:published_time" content="2022-10-09T10:00:00.000Z">
<meta property="article:modified_time" content="2022-10-14T07:57:21.744Z">
<meta property="article:author" content="hyh">
<meta property="article:tag" content="射频开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081549710.png">


<link rel="canonical" href="https://hyh.cool/post/18/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hyh.cool/post/18/","path":"/post/18/","title":"SX1261/2芯片学习笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SX1261/2芯片学习笔记 | hyh's Blog</title>
  





<script async defer data-website-id="" src=""></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">hyh's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tech"><a href="/tech/" rel="section"><i class="fas fa-wrench fa-fw"></i>技术</a></li><li class="menu-item menu-item-microchip"><a href="/microchip/" rel="section"><i class="fas fa-microchip fa-fw"></i>芯片</a></li><li class="menu-item menu-item-project"><a href="/project/" rel="section"><i class="fas fa-rocket fa-fw"></i>项目</a></li><li class="menu-item menu-item-source"><a href="/source/" rel="section"><i class="fas fa-file fa-fw"></i>资料</a></li><li class="menu-item menu-item-reading"><a href="/reading/" rel="section"><i class="fas fa-book fa-fw"></i>阅读</a></li><li class="menu-item menu-item-photos"><a href="/photos/" rel="section"><i class="fas fa-camera-retro fa-fw"></i>相册</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fas fa-splotch fa-fw"></i>留言</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          目 录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%AE%80%E4%BB%8B"><span class="nav-text">一、简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E7%94%B5%E8%B7%AF%E6%8F%8F%E8%BF%B0"><span class="nav-text">二、电路描述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%97%B6%E9%92%9F%E5%8F%82%E8%80%83"><span class="nav-text">1.时钟参考</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RC-%E6%97%B6%E9%92%9F%E5%8F%82%E8%80%83"><span class="nav-text">RC 时钟参考</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%AB%98%E7%B2%BE%E5%BA%A6%E6%97%B6%E9%92%9F%E5%8F%82%E8%80%83"><span class="nav-text">高精度时钟参考</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-XTAL%E6%8E%A7%E5%88%B6%EF%BC%88%E6%97%A0%E6%BA%90%E6%99%B6%E6%8C%AF%EF%BC%89"><span class="nav-text">2.XTAL控制（无源晶振）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-TCXO%E6%8E%A7%E5%88%B6%EF%BC%88%E6%9C%89%E6%BA%90%E6%99%B6%E6%8C%AF%EF%BC%89"><span class="nav-text">3.TCXO控制（有源晶振）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E9%94%81%E7%9B%B8%E7%8E%AF"><span class="nav-text">4.锁相环</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%8E%A5%E6%94%B6%E9%93%BE%E8%B7%AF"><span class="nav-text">5.接收链路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E5%8F%91%E5%B0%84%E9%93%BE%E8%B7%AF"><span class="nav-text">6.发射链路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%8A%9F%E7%8E%87%E5%88%86%E9%85%8D"><span class="nav-text">三、功率分配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%80%89%E6%8B%A9DC-DC%E6%88%96%E8%80%85LDO"><span class="nav-text">1.选择DC-DC或者LDO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%BF%87%E6%B5%81%E4%BF%9D%E6%8A%A4%E9%85%8D%E7%BD%AE"><span class="nav-text">2.过流保护配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%B0%83%E5%88%B6%E8%A7%A3%E8%B0%83"><span class="nav-text">四、调制解调</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-LoRa%E8%B0%83%E5%88%B6"><span class="nav-text">1.LoRa调制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%89%A9%E9%A2%91%E5%9B%A0%E5%AD%90"><span class="nav-text">扩频因子</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E5%88%B6%E5%B8%A6%E5%AE%BD"><span class="nav-text">调制带宽</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FEC%E7%BC%96%E7%A0%81%E7%8E%87"><span class="nav-text">FEC编码率</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%8E%E7%A9%BA%E9%80%9F%E4%BC%98%E5%8C%96"><span class="nav-text">低空速优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LoRa%E5%B8%A7%E6%A0%BC%E5%BC%8F"><span class="nav-text">LoRa帧格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LoRa%E4%BF%A1%E9%81%93%E6%B4%BB%E5%8A%A8%E6%A3%80%E6%B5%8B%EF%BC%88CAD-Channel-Activity-Detection%EF%BC%89"><span class="nav-text">LoRa信道活动检测（CAD,Channel Activity Detection）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-FSK%E8%B0%83%E5%88%B6"><span class="nav-text">2.FSK调制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E5%88%B6%E5%8F%82%E6%95%B0"><span class="nav-text">调制参数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%95%B0%E6%8D%AE%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="nav-text">五、数据缓冲区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E6%95%B0%E5%AD%97%E6%8E%A5%E5%8F%A3%E5%8F%8A%E6%8E%A7%E5%88%B6"><span class="nav-text">六、数字接口及控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%A4%8D%E4%BD%8D%E5%BC%95%E8%84%9A"><span class="nav-text">1.复位引脚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-SPI%E7%9B%B8%E5%85%B3%E5%BC%95%E8%84%9A"><span class="nav-text">2.SPI相关引脚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-BUSY%E5%BC%95%E8%84%9A"><span class="nav-text">3.BUSY引脚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-DIO%E5%BC%95%E8%84%9A"><span class="nav-text">4.DIO引脚</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="nav-text">七、关键函数解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text">1.设置工作模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetStandby"><span class="nav-text">SetStandby</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetTx"><span class="nav-text">SetTx</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetRx"><span class="nav-text">SetRx</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetSleep"><span class="nav-text">SetSleep</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%8A%9F%E7%8E%87%E8%AE%BE%E7%BD%AE"><span class="nav-text">2.功率设置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetTxParams"><span class="nav-text">SetTxParams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetPaConfig"><span class="nav-text">SetPaConfig</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PA-Optimal-Settings"><span class="nav-text">PA Optimal Settings</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%A2%91%E7%8E%87%E8%AE%BE%E7%BD%AE"><span class="nav-text">3.频率设置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetRfFrequency"><span class="nav-text">SetRfFrequency</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CalibrateImage"><span class="nav-text">CalibrateImage</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E8%B0%83%E5%88%B6%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="nav-text">4.调制参数设置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetModulationParams"><span class="nav-text">SetModulationParams</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E8%8E%B7%E5%8F%96%E8%8A%AF%E7%89%87%E7%8A%B6%E6%80%81%E4%BB%A5%E5%8F%8A%E8%AE%BE%E5%A4%87%E9%94%99%E8%AF%AF%E7%8A%B6%E6%80%81"><span class="nav-text">5.获取芯片状态以及设备错误状态</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GetStatus"><span class="nav-text">GetStatus</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GetDeviceErrors"><span class="nav-text">GetDeviceErrors</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E8%8E%B7%E5%8F%96RSSI"><span class="nav-text">6.获取RSSI</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GetRssiInst"><span class="nav-text">GetRssiInst</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GetPacketStatus"><span class="nav-text">GetPacketStatus</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E5%8F%91%E9%80%81%E5%8D%95%E8%BD%BD%E6%B3%A2"><span class="nav-text">7.发送单载波</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetTxContinuousWave"><span class="nav-text">SetTxContinuousWave</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-%E4%B8%AD%E6%96%AD%E7%8A%B6%E6%80%81%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-text">8.中断状态相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SetDioIrqParams"><span class="nav-text">SetDioIrqParams</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GetIrqStatus"><span class="nav-text">GetIrqStatus</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ClearIrqStatus"><span class="nav-text">ClearIrqStatus</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3%E8%B0%83%E8%AF%95%E7%BB%8F%E9%AA%8C"><span class="nav-text">八、认证相关调试经验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">九、总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hyh"
      src="/resources/img/avatar.jpg">
  <p class="site-author-name" itemprop="name">hyh</p>
  <div class="site-description" itemprop="description">非能知己,莫能知人</div>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://gitee.com/hyh1370039199" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;hyh1370039199" rel="noopener" target="_blank"><i class="fa-brands fa-solid fa-g fa-fw"></i></a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hyh.cool/post/18/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/resources/img/avatar.jpg">
      <meta itemprop="name" content="hyh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hyh's Blog">
      <meta itemprop="description" content="非能知己,莫能知人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SX1261/2芯片学习笔记 | hyh's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SX1261/2芯片学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-09 18:00:00" itemprop="dateCreated datePublished" datetime="2022-10-09T18:00:00+08:00">2022-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/tech/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="一、简介">一、简介</h3>
<p>SX1261/2 是半双工收发芯片，能够低功耗地工作在$150-960MH$z ISM频段。如下图所示。其包括模拟前端、数字调制解调、数字接口与控制、电源四个主要功能部分。</p>
<blockquote>
<p>ISM(Industrial Scientific Medical) Band，是由ITU-R （ITU Radiocommunication Sector，国际通信联盟无线电通信局）定义的。这些频段是为电信之外的其他射频用途挪出的频段。</p>
</blockquote>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081549710.png" style="zoom: 50%;" />
<ol>
<li>
<p><strong>模拟前端部分</strong>：该部分为发射和接收链路，以及数据转换接口。SX1261与SX1262的发射链路中最后的功率放大电路是不相同的。SX1261在DC-DC或者LDO模式下都能够输出最大$+14/15dBm$的功率。SX1262在电池供电模式下能够输出最大$+22dBm$的功率。</p>
</li>
<li>
<p><strong>数字调制解调部分</strong>：该款芯片支持两种调制解调方式：</p>
<p>​	①LoRa：带宽(BW)为7.8~500kHz，扩频因子(SF)为5~12，比特速率为0.018~62.5kb/s。</p>
<p>​    ②（G）FSK：比特速率为0.6~300kb/s。</p>
</li>
<li>
<p><strong>数字接口和控制部分</strong>：该部分包括所有的有效载荷和协议处理以及通过SPI接口对芯片进行配置的功能。</p>
</li>
<li>
<p><strong>电源部分</strong>：该部分包含DC-DC或者LDO两种形式的电压转换器。</p>
</li>
</ol>
<h3 id="二、电路描述">二、电路描述</h3>
<h4 id="1-时钟参考">1.时钟参考</h4>
<h5 id="RC-时钟参考">RC 时钟参考</h5>
<p>有两个RC时钟源可用：64kHz、13MHz。可以使用64kHz振荡器在执行周期性或占空比操作时唤醒射频芯片。13MHz的RC振荡器可用于所有SPI通信。</p>
<h5 id="高精度时钟参考">高精度时钟参考</h5>
<p>由于LoRa芯片大功率发射时会发出大量热量，这个热量会热传导到外围晶振上，<font color=#FF0000>当未使用温补晶振（TCXO）时，晶振由于温度升高导致频率发生变化。普通晶振的振动频率随温度升高而降低。晶振提供的振荡频率发生偏移时，会影响整个LoRa射频芯片的锁相环频率，导致 LoRa设备发射的信号频率偏移</font>，当偏移频率大于一个极限时，就会发生丢包现象。</p>
<p><strong>在LoRa调制下应该使包传输时间内的频率偏移降至最小并且低于$Freqdriftmax$</strong>:<br>
$$<br>
Freqdriftmax = \frac{BW}{3\times{2^{SF}}}<br>
$$<br>
<strong>在低空速模式下LowDataRateOptimize配置为0x01，可以将包传输时间内的频率偏移要求放松至$16\times{Freqdriftmax}$</strong>：<br>
$$<br>
Freqdriftmax = \frac{BW}{3\times{2^{SF } } }	\times{16}<br>
$$</p>
<h4 id="2-XTAL控制（无源晶振）">2.XTAL控制（无源晶振）</h4>
<p>SX1261/2芯片不需要硬件在32MHz晶振旁加入电容元件。<font color=#FF0000><strong>该芯片引脚XTA、XTB配置了可编程电容器。电容器的值以0.47pF为步长，0x00会设置电容值为11.3pF（最小值），0x2F设置电容值为33.4pF（最大值）</strong></font>.</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081654895.png" alt=""></p>
<blockquote>
<p>补充知识：</p>
<img data-src="https://hyh1370039199.oss-cn-chengdu.aliyuncs.com/img/img/20220316151735.png"  style="zoom:50%;" />
<p>根据下列公式来设置晶振旁的两个负载电容$C_g$和$C_d$：<br>
$$<br>
C_l \approx \frac{C_g * C_d}{C_g + C_d} + C_s<br>
$$<br>
其中$C_l$ 为晶振的标称负载电容，$C_s$为PCB的杂散电容，$C_s$一般经验值为3-5$pF$，并且一般取$C_g$ = $C_d$。晶振的标称负载电容可以查阅晶振的数据手册。$C_g$ 和 **$C_d$**变大晶体振荡的频率变小；$C_g$ 和 $C_d$变小晶体振荡的频率变大；</p>
</blockquote>
<p><strong>注意</strong>：使用XTAL时，在POR上电复位或冷启动模式下从休眠唤醒时，电容寄存器将值初始化为0x05(13.6pF)。<font color=#FF0000><strong>芯片设置为STDBY_XOSC模式，两个寄存器的值会被覆盖为0x12(19.7pF)。因此用户确保设备已处于STDBY_XOSC模式，然后才能更改电容寄存器的值，以免被覆盖</strong></font>。</p>
<h4 id="3-TCXO控制（有源晶振）">3.TCXO控制（有源晶振）</h4>
<p>使用TCXO时，<strong>应通过一个220Ω电阻和一个10pF直流截止电容将其连接到XTA引脚</strong>，XTB引脚保持未连接状态。DIO3引脚可用于为TCXO提供稳压直流电压，可编程范围1.6V至3.3V。$V_{BAT}$应始终比编程电压高200mV，以确保正常工作。</p>
<p><code>SetDIO3AsTCXOCtrl</code>该命令用于配置DIO3控制外部TCXO参考电压。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081736102.png" alt=""></p>
<p><strong>注意</strong>：使用TCXO时，<code>SetDIO3AsTCXOCtrl</code>该命令被设置后，控制XTA内部电容值的寄存器将自动更改为0x2F（33.4pF），来过滤传播到PLL的杂散。</p>
<p>使用此命令后，设备会在需要时（在STDBY_XOSC、FS、TX、RX模式下），将DIO3设置为预定义的输出电压。32MHz出现并稳定所需的时间可以通过参数delay（23:0）来控制。如果在延迟周期结束时，内部未检测到来自TCXO的32MHz，则错误控制器将标记错误 XOSC_START_ERR.</p>
<h4 id="4-锁相环">4.锁相环</h4>
<p>锁相环（PLL,Phase-Locked Loop）是一种反馈控制电路。其特点为：<strong>利用外部的参考信号控制环路内部振荡信号的频率和相位</strong>。锁相环在工作的过程中，当输出信号的频率与输入信号的频率相等时，输出电压与输入电压保持固定的相位差值，即输出电压与输入电压的相位被锁住，这就是锁相环的名称由来。</p>
<p>锁相环通常由鉴相器（PD,Phase Detector）、环路滤波器（LF,Loop Filter）和压控振荡器（VCO，Volatge Controlled Oscillator）三部分组成，锁相环组成的原理框图所下图所示。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091552944.png" style="zoom: 50%;" />
<p><strong>工作原理</strong>：压控振荡器的输出经过采集并分频；和基准信号同时输入鉴相器；鉴相器通过比较上述两个信号的频率差，然后输出一个直流脉冲电压；控制VCO，使它的频率改变；这样经过一个很短的时间，VCO的输出就会稳定于某一期望值。</p>
<h4 id="5-接收链路">5.接收链路</h4>
<p>接收到的射频信号首先经差分低噪声放大器（LNA）放大，然后经正交配置的混频器，下转换为低中频中频信号，I和Q信号经过低通滤波，然后由一个连续时间反馈结构转换器（ADC）进行数字化。一旦进入数字域，信号就被抽取，再次下转换，再次抽取，信道滤波并最终由选定的调制解调器根据调制方案解调。</p>
<h4 id="6-发射链路">6.发射链路</h4>
<p>射频芯片的默认最大输出功率为SX1261: +14dBm，SX1262: +22dBm，输出功率可编程，具有32dB的动态范围，1dB的步进。</p>
<p>SX1261/2芯片的供电方式为DC-DC或LDO，<font color=#FF0000><strong>使用DC-DC供电效率会更高，系统的供电电流会更小</strong></font>。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081933360.png"  style="zoom:50%;" />
<p><strong>① SX1261功率放大器特性</strong></p>
<p>对于SX1261芯片，当采用内部DC-DC供电时，发射机的功率效率将达到最高。在DC-DC模式下，总功耗将直接受供电电压的影响。</p>
<p><strong>② SX1262功率放大器特性</strong></p>
<p>SX1262工作在DC-DC模式时，DC-DC只负责为内核供电。对于SX1262，功率放大器优化了最大输出功率，同时最大限度地提高了效率，这导致如果要使SX1262保持较高的输出功率，就必须为其功率放大器提供相当高的电压。当输出功率最大时，功率放大器的电流效率最高，其输出功率受限于供电电压。</p>
<h3 id="三、功率分配">三、功率分配</h3>
<h4 id="1-选择DC-DC或者LDO">1.选择DC-DC或者LDO</h4>
<p>用户可以使用命令<code>SetRegulatorMode</code>来指定DC-DC的使用。此操作必须仅以STDBY_RC模式执行。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081951587.png" alt=""></p>
<h4 id="2-过流保护配置">2.过流保护配置</h4>
<p>OCP可以以2.5mA的步进进行配置，默认值会在每次调用<code>SetPaConfig</code>函数时自动重新配置，如果用户希望调整OCP值，则有必要在调用<code>SetPaConfig</code>函数的第二步进行设置。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210081958611.png" alt=""></p>
<h3 id="四、调制解调">四、调制解调</h3>
<h4 id="1-LoRa调制">1.LoRa调制</h4>
<p>开发人员可以设置四个关键的设计参数，每个参数需要在链路预算、抗干扰能力、频谱占用率和标称数据速率之间权衡：</p>
<ul>
<li>调制带宽（BW_L）</li>
<li>扩频因子（SF）</li>
<li>编码率（CR）</li>
<li>低空速优化（LDRO）</li>
</ul>
<p>使用<code>SetModulationParams</code>命令设置这些参数，此命令必须在<code>SetPacketType</code>之后调用。</p>
<h5 id="扩频因子">扩频因子</h5>
<p>LoRa扩频技术通过由多个信息片表示每个有效载荷信息位来执行。标称符号速率和数据速率之间的比值是扩频因子。它表示每位信息发送的符号数。</p>
<p><strong>注意</strong>：对于SF5和SF6两个参数，推荐用户使用12个前导符号，以确保正确检测和解调，并具有最佳性能。</p>
<p>由于不同的扩频因子彼此正交，因此在链路的发送端和接收端都必须事先知道扩频因子，<font color=#FF0000><strong>还需注意在每个不同扩频因子参数下的最大负信噪比。（正是这种接收负信噪比信号的能力提高LoRa芯片的灵敏度以及链路预算、范围。）</strong></font></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082019176.png" alt=""></p>
<p><font color=#FF0000><strong>扩频因子越大，传输时间越短，负信噪比越大，接收灵敏度更好。</strong></font>LoRa符号速率公式为：<br>
$$<br>
R_{s} = \frac{BW}{2^{SF}}<br>
$$</p>
<h5 id="调制带宽">调制带宽</h5>
<p>信道带宽的增加会使有效数据速率提高，从而降低了灵敏度，减少了传输时间。LoRa调制带宽总是指双边带（DSB）。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082028349.png" alt=""></p>
<p>对于BW为250kHz时，接收端执行两次转换，第一次在RF链路中下变换到低中频，第二次在基带调制解调器以数字方式进行基带转换。当使用500kHz带宽时，在RF部分执行一次下变换到零中频。</p>
<h5 id="FEC编码率">FEC编码率</h5>
<p><font color=#FF0000><strong>编码率越高，抗噪声能力越强，但传输时间越长</strong></font>。在强干扰存在的情况下，可以使用更高的编码速率。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082119609.png" alt=""></p>
<h5 id="低空速优化">低空速优化</h5>
<p><font color=#FF0000><strong>根据有效载荷的大小，当LoRa符号时间大于等于16.38ms，通常建议使用低空速优化</strong></font>。</p>
<h5 id="LoRa帧格式">LoRa帧格式</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082127155.png" alt=""></p>
<h6 id="前导">前导</h6>
<p>LoRa PHY数据包的Preamble（前导）包含三部分：</p>
<p><strong>（variable preamble）可变前导码</strong>：用于使接收端与传入信号同步，默认情况下，数据包配置为12个符号的前导码。前导码范围为10~65535.<font color=#FF0000><strong>前导码为up-chirp符号。</strong></font></p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082222500.png"  style="zoom:33%;" />
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082158878.png" alt=""></p>
<p><strong>（Sync Word）帧同步字</strong>：可变长度前导码后，是两个符号宽度的帧同步字，可以用来快速识别不同的LoRa网络，LoRa芯片会直接丢弃真同步字内容与预设值不一致的数据包。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082159872.png" alt=""></p>
<p><strong>（SFD，Start Frame Delimiter）帧起始分隔符</strong>(<strong>可以理解为前导码结束标记</strong>)：LoRa规范中数据包SFD为占2.25个符号宽度的标准down-chirp信号，标准down-chirp信号如下图所示：</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082202252.png" style="zoom:33%;" />
<p>LoRa PHY前导chirp波形如图所示：</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082204769.png"  style="zoom:67%;" />
<p><font color=#FF0000>对比LoRa两代的核心芯片后可以发现，新一代以SX1268代表的芯片，可以通过寄存器直接设置PHY层包格式中占两个符号宽度的Sync word值。但是前一代以SX1278为代表的芯片，通过寄存器只能设置一个符号之，因此如何由该一个符号设置值，扩展成两个符号宽度的PHY波形中的Sync Word值，是一个待确定的问题。</font></p>
<p>由于LoRa底层标准未公开，目前对此部分数据映射，目前没有明确结论，只有几个猜想：假设SX1278等Sync Word设置为X：</p>
<ul>
<li>PHY中的两个符号，分别为$x$和$2^{SF}-x$</li>
<li>PHY中的两个符号，分别为$x$和$x$</li>
<li>将x的高四位和低四位分别映射到两个符号，映射关系如下图所示：</li>
</ul>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210082221939.png"  style="zoom: 33%;" />
<p>LoRa PHY数据包分别有两种Header模式：Explicit Header mode（<strong>显式包头</strong>）和Implicit Header mode（<strong>隐式包头</strong>），区别在于显式模式会在PHT的数据包中包含Header的内容，而隐式模式的数据包不包含Header的内容，为了进一步减少无线信号传递的内容，进一步达到节约传输时间，减少数据包冲突，降低模块运行功耗等目的。</p>
<h6 id="包头">包头</h6>
<p>Header包括的内容有：payload数据包长度，CR编码方式，payload后是否包含CRC数据以及header内容的CRC。共占2.5字节长度，也就是20个Bit。<strong>注意Header部分固定采用CR=4/8的编码方式。</strong></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090918020.png" alt=""></p>
<p>Payload数据包长度：Header中的第一个Byte用于表示整个数据包中后续Payload内容的长度，占了8个bit，因此一包LoRa数据中，后续payload内容最大为255Byte。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090923777.png" alt=""></p>
<p>编码率选择：LoRa标准定义了四种编码方式，分别将4个bit原始数据，经过编码后变化至5，6，7，8四种长度的数据。这四种编码方式的选择。定义在LoRa Header 中数据包长度接下来的半个Byte中的3个bit。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090929165.png" alt=""></p>
<p>CRC存在控制：LoRa数据包的CRC是可以选择传输或者不传输，该机制的控制，定义在了编码率选择后的1个bit。如果数据包中存在CRC，那么还需要数据包后额外再传输2个Byte内容，即16bit CRC。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210090934972.png" alt=""></p>
<p>Header数据校验：LoRa Header数据中的最后一个Byte内容为Header数据字段的CRC校验。</p>
<h5 id="LoRa信道活动检测（CAD-Channel-Activity-Detection）">LoRa信道活动检测（CAD,Channel Activity Detection）</h5>
<p>在确定信道是否被低于接收机底噪的信号占用，这种情况使用RSSI显然不可行的，因此需要CAD模式。</p>
<p>芯片设定为进入CAD模式后，SX1261/2将在用户可选择的持续时间内（以数量定义）对频带进行扫描，如果在CAD过程中检测到LoRa信号,将会触发Cad中断。<font color=#FF0000>注意：无论是否有信号到来，都会产生CADDone中断，当有匹配（相同的频率和扩频因子）的信号到来时，就会产生CADDetect中断，CADDone也会产生。</font></p>
<h4 id="2-FSK调制">2.FSK调制</h4>
<p><strong>由于LoRa测试灵敏度环境搭建复杂，FSK调制常常作为测试灵敏度所用的调制方式，作为判断硬件设计射频性能的一个依据。</strong></p>
<h5 id="调制参数">调制参数</h5>
<p>使用<code>SetModulationParams</code>命令设置这些参数，此命令必须在<code>SetPacketType</code>之后调用。</p>
<h6 id="比特率">比特率</h6>
<p>寄存器中的比特率值(BR)表示为晶振频率的32倍除以设备实际的比特率，公式表示为：<br>
$$<br>
BR = \frac{F_{XOSC}}{BitRate}\times{32}<br>
$$<br>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091029524.png" alt=""></p>
<h6 id="频偏">频偏</h6>
<p>寄存器中的Fdev值与设备实际频偏的关系表达式如下：<br>
$$<br>
Frequencydeviation = \frac{F_{dev}\times{F_{XTAL}}}{2^{25}}<br>
$$<br>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091044770.png" alt=""></p>
<h6 id="接收带宽">接收带宽</h6>
<p>用户需要根据其条件选择最佳的接收带宽，为了确保正确的解调，在选择带宽时必须遵守以下限制：<br>
$$<br>
（2*Fdev + BR）&lt; BW<br>
$$</p>
<p>$$<br>
Bandwidth \geqslant BR + 2*frequency deviation + frequency error<br>
$$</p>
<p><font color=#FF0000>注意：频率误差应是晶振误差的两倍</font>。</p>
<h6 id="帧格式">帧格式</h6>
<p><strong>固定包长数据包</strong></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091108439.png" alt=""></p>
<p><strong>可变包长数据包</strong></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091143039.png" alt=""></p>
<h6 id="白化">白化</h6>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091402631.png"  style="zoom:67%;" />
<p>线性反馈移位寄存器（LFSR）多项式为：<br>
$$<br>
g(x) = x^9 + x^5 + 1<br>
$$<br>
更新的算法如下：</p>
<p>1.白化序列新的第9位由第0位与第5位异或产生</p>
<p>2.整体右移一位</p>
<p>3.重复1，2步骤8次</p>
<p>白化序列初始值设置如下图所示：</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091412623.png" alt=""></p>
<h6 id="CRC">CRC</h6>
<p>可以使用命令<code>SetPacketParam</code>中的<code>CRCType</code>字段 启用和配置CRC。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091415680.png" style="zoom: 50%;" />
<p>CRC初始值：<font color=#FF0000><strong>开发人员可以利用读取该寄存器的初始值作为判断MCU SPI功能是否正常，是否可以与射频芯片正常交互</strong></font>。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*!
 *  @brief   检测SX126X芯片是否存在
 *  @note    1=> 存在,  0=> 不存在或SPI交互有问题
*/</span>
INT8U <span class="token function">SX126X_GetIsExist</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INT8U byte<span class="token punctuation">;</span>
  byte <span class="token operator">=</span> <span class="token function">SX126X_ReadRegister</span><span class="token punctuation">(</span><span class="token number">0x06BC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>byte <span class="token operator">==</span> <span class="token number">0x1D</span><span class="token punctuation">)</span><span class="token comment">//0x1D为0x06BC寄存器的复位值</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091423666.png"  style="zoom: 50%;" />
<p>CRC多项式：允许用户选取任何标准CRC或使用自己的CRC</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091430107.png" alt=""></p>
<p>要使用<strong>IBM CRC</strong>配置，用户必须选择以下参数：</p>
<ul>
<li>CRC多项式：0x8005</li>
<li>初始值：0xFFFF</li>
<li>CRCType： CRC_2_BYTE</li>
</ul>
<p>要使用 <strong>CCIT CRC</strong>配置，用户必须选择以下参数：</p>
<ul>
<li>CRC多项式：0x1021</li>
<li>初始值：0x1D0F</li>
<li>CRCType： CRC_2_BYTE_INV</li>
</ul>
<h3 id="五、数据缓冲区">五、数据缓冲区</h3>
<p>射频芯片具有256字节的RAM数据缓冲区，除了休眠模式，其他模式都可以访问。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091435678.png"  style="zoom: 50%;" />
<p>由于Tx，Rx模式独立互不影响，<font color=#FF0000>开发时可以调用 <code>SX126xSetBufferBaseAddress( 0x00, 0x00 );</code>函数 使得TxBufferPointer、RxStartBufferPointer均在0x00起始</font>。</p>
<blockquote>
<p>注意：即使CRC是无效的，所有接收到的数据将写入数据区，允许用户自行处理损坏的数据，<font color=#FF0000><strong>这亦是我们测试灵敏度和开发测试中模块可以收到乱码的原因，如果不想要乱码的数据，请在中断触发事件中开启CRC Error事件，在检测接收中断RxDone事件触发后，再检测是否触发CRC Error，进而屏蔽掉乱码的数据</strong></font>。</p>
</blockquote>
<h3 id="六、数字接口及控制">六、数字接口及控制</h3>
<h4 id="1-复位引脚">1.复位引脚</h4>
<p>数据手册中标称，将Reset引脚拉低100us即可复位。<strong>开发时建议软件复位加一点冗余量</strong>，源码如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">Gpio_SetIO</span><span class="token punctuation">(</span>SX126X_NRST_PORT<span class="token punctuation">,</span>SX126X_NRST_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_ClrIO</span><span class="token punctuation">(</span>SX126X_NRST_PORT<span class="token punctuation">,</span>SX126X_NRST_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Gpio_SetIO</span><span class="token punctuation">(</span>SX126X_NRST_PORT<span class="token punctuation">,</span>SX126X_NRST_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WaitOnBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="2-SPI相关引脚">2.SPI相关引脚</h4>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091512061.png" alt=""></p>
<p>对于单片机如何配置 SPI，有两个重要参数：SPI 的<strong>时钟极性 CPOL</strong> 表示时钟信号在空闲时是高电平还是低电平；<strong>时钟相位 CPHA</strong> 表示何时进行信号采样，在第一个跳变沿，还是第二个跳变沿。</p>
<p>由数据手册得知：<strong>CPOL = 0  CPHA = 0</strong></p>
<p>NSS引脚在帧起始位置拉低，在数据字节传输完成拉高。</p>
<p>注意：该射频芯片SPI速率最大支持16M。</p>
<blockquote>
<p><font color=#FF0000><strong>为了提高代码的可移植性以及可读性，建议RF底层关于SPI接口的操作（例如片选引脚拉高拉低，SPI交换字节等），以及一些GPIO引脚操作 用宏定义函数封装一下，便于后续替换单片机时进行移植</strong></font>。</p>
</blockquote>
<p>源码如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//宏定义函数封装</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SX126X_NSS_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token function">Spi_SetCS</span><span class="token punctuation">(</span>M0P_SPI0<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SX126X_NSS_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token function">Spi_SetCS</span><span class="token punctuation">(</span>M0P_SPI0<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPI_Exchange_Byte</span><span class="token expression"><span class="token punctuation">(</span>data<span class="token punctuation">)</span>   <span class="token function">hal_spi_exchange_byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span></span>

<span class="token comment">//写访问寄存器</span>
<span class="token keyword">void</span> <span class="token function">SX126X_WriteRegisters</span><span class="token punctuation">(</span>INT16U address<span class="token punctuation">,</span>INT8U <span class="token operator">*</span>buffer<span class="token punctuation">,</span>INT16U size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">SX126X_CheckDeviceReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_NSS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//NSS引脚拉低</span>
    
    <span class="token function">SPI_Exchange_Byte</span><span class="token punctuation">(</span>RADIO_WRITE_REGISTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Exchange_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_Exchange_Byte</span><span class="token punctuation">(</span>address <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span>size<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">SPI_Exchange_Byte</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">SX126X_NSS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//NSS引脚拉高</span>
    <span class="token function">SX126X_WaitOnBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="3-BUSY引脚">3.BUSY引脚</h4>
<p>Busy引脚用于指示射频芯片的状态，当BUSY引脚为低电平时，它表示射频芯片处于空闲模式，并且芯片已准备好接收来自主机的命令。</p>
<p>下面是BUSY引脚在射频各个工作模式的电平状态：</p>
<ul>
<li>在Sleep模式，Busy引脚拉高；当芯片退出休眠时，Busy引脚拉低。</li>
<li>在FS模式，当锁相环锁定时，Busy引脚拉低。</li>
<li>在RX模式，当RX准备好接收数据，Busy引脚将会拉低。</li>
<li>在TX模式，当功率放大器已经放大并且前导码开始传输，Busy引脚将会拉低。</li>
<li>当射频芯片在处理IRQ时，Busy引脚会拉高。</li>
</ul>
<h4 id="4-DIO引脚">4.DIO引脚</h4>
<p>可以选择3个DIO中的任何一个作为输出中断源。当中断触发后，它可以通过调用<code>GetIrqStatus</code>函数来确定源，然后可以调用<code>ClearIrqStatus</code>函数清除中断。</p>
<p><font color=#FF0000>DIO引脚初始状态为低电平，中断触发时为高电平</font>。</p>
<p><strong>DIO1</strong> ：任何中断都可以映射到DIO1.</p>
<p><strong>DIO2</strong> ：具有两项功能：①可作为中断映射引脚；②<font color=#FF0000>调用<code>SetDio2AsRfSwitchCtrl</code>函数配置作为驱动射频开关的引脚，此时DIO2在Tx模式下为高电平，其余时刻为低电平</font>。</p>
<p><strong>DIO3</strong> ：具有两项功能：①可作为中断映射引脚；②<font color=#FF0000>调用<code>SetDio3AsTCXOCtrl</code>函数作为TCXO的电源</font>。</p>
<h3 id="七、关键函数解析">七、关键函数解析</h3>
<h4 id="1-设置工作模式">1.设置工作模式</h4>
<h5 id="SetStandby">SetStandby</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091648276.png" alt=""></p>
<p>对于射频芯片使用32MHz有源晶振和无源晶振在初始化时的区别，源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_sx126x_param<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_sx126x_param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_IOInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//SX1262 IO初始化</span>
    <span class="token function">SX126X_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//复位</span>
    <span class="token function">SX126X_WakeUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//唤醒</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SX126X_GetIsExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//验证MCU SPI功能是否正常</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">debug_printf</span><span class="token punctuation">(</span><span class="token string">"sx126x is not existed!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_TCXO</span></span>
    <span class="token comment">//有源晶振</span>
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_RC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetDio3AsTcxoCtrl</span><span class="token punctuation">(</span>TCXO_CTRL_2_2V<span class="token punctuation">,</span>DEF_TCXO_CTRL_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_XOSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">//无源晶振</span>
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_XOSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTA_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//负载电容</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTB_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">SX126X_SetRegulatorMode</span><span class="token punctuation">(</span>USE_DCDC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetBufferBaseAddress</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetDio2AsRfSwitchCtrl</span><span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></code></pre>
<p><font color=#FF0000><strong>请注意：内部负载电容的设置必须在调用<code>SX126X_SetStandby(STDBY_XOSC);</code>函数后执行，否则写入负载电容寄存器的值会被覆盖</strong></font>。</p>
<h5 id="SetTx">SetTx</h5>
<p><strong>切换至Tx模式的具体步骤：</strong></p>
<ul>
<li>从STDBY_RC模式开始，切换至STDBY_XOSC模式，PLL开启。PA开启，PA根据设置的斜坡时间开始放大。</li>
<li>当放大完成后，数据包开始传输。</li>
<li>当数据包的最后一位被发送时，触发TxDone中断，PA关闭，芯片回到STDBY_RC模式。</li>
<li>如果TxDone中断没有在给定的超时时间内生成，则触发发送超时中断，芯片回到STDBY_RC模式。</li>
</ul>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091726754.png" alt=""></p>
<p>超时持续时间使用下式计算：<br>
$$<br>
Timeout_{duration} = Timeout \times {15.625us}<br>
$$<br>
源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_SetTx</span><span class="token punctuation">(</span>INT32U timeout<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_XOSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTA_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTB_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_sx126x_param<span class="token punctuation">.</span>OperatingMode <span class="token operator">=</span> MODE_TX<span class="token punctuation">;</span>
    <span class="token function">SX126X_SetDioIrqParams</span><span class="token punctuation">(</span>IRQ_TX_DONE <span class="token operator">|</span> IRQ_RX_TX_TIMEOUT<span class="token punctuation">,</span>
                                    IRQ_TX_DONE <span class="token operator">|</span> IRQ_RX_TX_TIMEOUT<span class="token punctuation">,</span>
                                    IRQ_RADIO_NONE<span class="token punctuation">,</span> IRQ_RADIO_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将中断事件映射到DIO1上，事件包括发送完成中断、发送超时中断</span>
    <span class="token function">SX126X_ClearIrqStatus</span><span class="token punctuation">(</span>IRQ_RADIO_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除全部中断</span>
    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>timeout <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>timeout <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>timeout <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_SET_TX<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote>
<p><font color=#FF0000>我们开发时采用的是Timeout为0的参数，对于发送超时或者发送中断未触发的异常情况，采用射频复位的方式解决</font>。</p>
</blockquote>
<h5 id="SetRx">SetRx</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092024938.png" alt=""></p>
<blockquote>
<p>我们开发时采用的是Timeout为0的参数，直到一次接收发生，否则一直处于接收状态。</p>
</blockquote>
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_SetRx</span><span class="token punctuation">(</span>INT32U timeout<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_XOSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTA_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTB_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_sx126x_param<span class="token punctuation">.</span>OperatingMode <span class="token operator">=</span> MODE_RX<span class="token punctuation">;</span>
    <span class="token function">SX126X_SetDioIrqParams</span><span class="token punctuation">(</span>IRQ_RX_DONE <span class="token operator">|</span> IRQ_RX_TX_TIMEOUT<span class="token operator">|</span>IRQ_PREAMBLE_DETECTED<span class="token punctuation">,</span>
                           IRQ_RX_DONE <span class="token operator">|</span> IRQ_RX_TX_TIMEOUT<span class="token operator">|</span>IRQ_PREAMBLE_DETECTED<span class="token punctuation">,</span>
                           IRQ_RADIO_NONE<span class="token punctuation">,</span>IRQ_RADIO_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将中断事件映射到DIO1上，事件包括接收完成、接收超时，前导码检测中断。</span>
    <span class="token function">SX126X_SetPacketParams</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_sx126x_param<span class="token punctuation">.</span>PacketParams<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置数据包参数</span>
    <span class="token function">SX126X_ClearIrqStatus</span><span class="token punctuation">(</span>IRQ_RADIO_ALL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除全部中断</span>
    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_SET_RX<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h5 id="SetSleep">SetSleep</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092030969.png" alt=""></p>
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//常用配置，休眠唤醒后寄存器值保留</span>
SleepParams_t sleepCfg<span class="token punctuation">;</span>
sleepCfg<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
sleepCfg<span class="token punctuation">.</span>Fields<span class="token punctuation">.</span>WarmStart <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SX126X_SetSleep</span><span class="token punctuation">(</span>SleepParams_t sleepCfg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    g_sx126x_param<span class="token punctuation">.</span>OperatingMode <span class="token operator">=</span> MODE_SLEEP<span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_SET_SLEEP<span class="token punctuation">,</span><span class="token operator">&amp;</span>sleepCfg<span class="token punctuation">.</span>Value<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="2-功率设置">2.功率设置</h4>
<h5 id="SetTxParams">SetTxParams</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091822473.png" alt=""></p>
<p>该函数参数power用作Tx输出功率，参数rampTime用作设置Tx斜坡时间。</p>
<ul>
<li>如果选择小功率PA，则输出功率为-17(0xEF)至+14(0x0E)dBm的范围内，步长为1dB。</li>
<li>如果选择大功率PA，则输出功率为-9(0xF7)至+22(0x16)dBm的范围内，步长为1dB。</li>
</ul>
<p>使用<code>SetPaConfig</code>函数中的参数$deviceSel$可以选择大功率PA还是小功率PA。</p>
<p>斜坡时间设置：</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091937839.png"  style="zoom: 50%;" />
<h5 id="SetPaConfig">SetPaConfig</h5>
<p>该函数用作PA配置；其设置参数有$paDutyCycle、hpMax、deviceSel、paLut$；其中$paDutyCycle$控制芯片功放的占空比，并且最大输出功率，功率消耗，谐波会随着功率周期的变化而急剧变化；hpMax则是控制芯片的输出功率上限；deviceSel是选择使用的设备类型。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091953209.png" alt=""></p>
<h5 id="PA-Optimal-Settings">PA Optimal Settings</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091956020.png" alt=""></p>
<p><font color=#FF0000><strong>使用PA最佳设置进行功率分档，理论上会比使用SetTxParam函数进行功率分档功耗更低</strong></font>。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210091959515.png" alt=""></p>
<p><font color=#FF0000><strong>注意：必须遵守以下限制避免PA过压，超过最大额定值可能会对设备造成不可逆的损坏!</strong></font></p>
<ul>
<li>SX1261：对于频率在400MHz以上，$paDutyCycle$不应高于0x07。</li>
<li>SX1261：对于频率低于400MHz，$paDutyCycle$不应高于0x04。</li>
<li>SX1262：$paDutyCycle$不应高于0x04。</li>
</ul>
<h4 id="3-频率设置">3.频率设置</h4>
<h5 id="SetRfFrequency">SetRfFrequency</h5>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092106654.png"  style="zoom:50%;" />
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*!
 * \brief Provides the frequency of the chip running on the radio and the frequency step
 *
 * \remark These defines are used for computing the frequency divider to set the RF frequency
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">XTAL_FREQ</span>                                   <span class="token expression"><span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span><span class="token number">32000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FREQ_DIV</span>                                    <span class="token expression"><span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span><span class="token function">pow</span><span class="token punctuation">(</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">25.0</span> <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FREQ_STEP</span>                                   <span class="token expression"><span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> XTAL_FREQ <span class="token operator">/</span> FREQ_DIV <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEF_XTA_TRIM_VALUE</span>                          <span class="token expression"><span class="token number">0x1C</span></span></span>
   
<span class="token keyword">void</span> <span class="token function">SX126X_SetRfFrequency</span><span class="token punctuation">(</span>INT32U frequency<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    INT32U freq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    CalibrationParams_t calibParams<span class="token punctuation">;</span>
    calibParams<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_Calibrate</span><span class="token punctuation">(</span>calibParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_CalibrateImage</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">SX126X_SetStandby</span><span class="token punctuation">(</span>STDBY_XOSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTA_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteRegister</span><span class="token punctuation">(</span>REG_XTB_TRIM<span class="token punctuation">,</span>DEF_XTA_TRIM_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    freq <span class="token operator">=</span> <span class="token punctuation">(</span>INT32U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>frequency<span class="token operator">/</span>FREQ_STEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>freq <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>freq <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>freq <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>freq <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_SET_RFFREQUENCY<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*!</span></code></pre>
<p>寄存器设置的Freq值与设备实际频率的关系表达式如下：<br>
$$<br>
Freq = \frac{ RF_{Freq} \times { F_{XTAL} } } { 2^{ 25 } }<br>
$$</p>
<h5 id="CalibrateImage">CalibrateImage</h5>
<p>校准是由参数freq1和freq2定义的频率范围进行的。设置不同的频率时，对于处于不同频率范围的情况，需要重新校准。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092112970.png" alt=""></p>
<h4 id="4-调制参数设置">4.调制参数设置</h4>
<h5 id="SetModulationParams">SetModulationParams</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092122212.png" alt=""></p>
<p>LoRa调制参数设置：①扩频因子SF；②调制带宽BW；③编码率CR；④低空速优化ldro。</p>
<p>GFSK调制参数设置：①比特率br；②脉冲整形PulseShape；③接受带宽Bandwidth；④Fdev频偏。</p>
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_SetModulationParams</span><span class="token punctuation">(</span> ModulationParams_t <span class="token operator">*</span>modulationParams <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> n<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> tempVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if required configuration corresponds to the stored packet type</span>
    <span class="token comment">// If not, silently update radio packet type</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> PacketType <span class="token operator">!=</span> modulationParams<span class="token operator">-></span>PacketType <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">SX126xSetPacketType</span><span class="token punctuation">(</span> modulationParams<span class="token operator">-></span>PacketType <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span> modulationParams<span class="token operator">-></span>PacketType <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> PACKET_TYPE_GFSK<span class="token operator">:</span>
        n <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        tempVal <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint32_t</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span>XTAL_FREQ <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span>modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>Gfsk<span class="token punctuation">.</span>BitRate <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tempVal <span class="token operator">>></span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tempVal <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> tempVal <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>Gfsk<span class="token punctuation">.</span>ModulationShaping<span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>Gfsk<span class="token punctuation">.</span>Bandwidth<span class="token punctuation">;</span>
        tempVal <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token class-name">uint32_t</span> <span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span>modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>Gfsk<span class="token punctuation">.</span>Fdev <span class="token operator">/</span> <span class="token punctuation">(</span> <span class="token keyword">double</span> <span class="token punctuation">)</span>FREQ_STEP <span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tempVal <span class="token operator">>></span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tempVal <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> tempVal<span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SX126xWriteCommand</span><span class="token punctuation">(</span> RADIO_SET_MODULATIONPARAMS<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PACKET_TYPE_LORA<span class="token operator">:</span>
        n <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>LoRa<span class="token punctuation">.</span>SpreadingFactor<span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>LoRa<span class="token punctuation">.</span>Bandwidth<span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>LoRa<span class="token punctuation">.</span>CodingRate<span class="token punctuation">;</span>
        buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> modulationParams<span class="token operator">-></span>Params<span class="token punctuation">.</span>LoRa<span class="token punctuation">.</span>LowDatarateOptimize<span class="token punctuation">;</span>

        <span class="token function">SX126xWriteCommand</span><span class="token punctuation">(</span> RADIO_SET_MODULATIONPARAMS<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token keyword">case</span> PACKET_TYPE_NONE<span class="token operator">:</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="5-获取芯片状态以及设备错误状态">5.获取芯片状态以及设备错误状态</h4>
<p><font color=#FF0000><strong>在开发调试时遇到芯片异常不工作时，可以采用以下这两个函数进行排查问题原因</strong></font>。</p>
<h5 id="GetStatus">GetStatus</h5>
<p>直接检测芯片当前状态，<font color=#FF0000>芯片出现异常，可以在每次切换模式后调用该函数，检查是否真正地切换到期望状态？</font></p>
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c">RadioStatus_t <span class="token function">SX126X_GetStatus</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U stat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    RadioStatus_t status<span class="token punctuation">;</span>
    <span class="token function">SX126X_ReadCommand</span><span class="token punctuation">(</span>RADIO_GET_STATUS<span class="token punctuation">,</span><span class="token punctuation">(</span>INT8U<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>stat<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    status<span class="token punctuation">.</span>Value <span class="token operator">=</span> stat<span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092101706.png" alt=""></p>
<h5 id="GetDeviceErrors">GetDeviceErrors</h5>
<p>使用该命令检测设备当前是否进入某种错误状态？</p>
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c">RadioError_t <span class="token function">SX126X_GetDeviceErrors</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    RadioError_t error<span class="token punctuation">;</span>
    <span class="token function">SX126X_ReadCommand</span><span class="token punctuation">(</span>RADIO_GET_ERROR<span class="token punctuation">,</span><span class="token punctuation">(</span>INT8U<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>error<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092118108.png" style="zoom:50%;" />
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092118580.png" style="zoom:50%;" />
<h4 id="6-获取RSSI">6.获取RSSI</h4>
<h5 id="GetRssiInst">GetRssiInst</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092045923.png" alt=""></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046557.png" alt=""></p>
<p>该函数获取的值为一个有符号整型，而串口输出的value是无符号整型。所以当前的信道噪声 = -（256 - value）；单位为dBm。</p>
<h5 id="GetPacketStatus">GetPacketStatus</h5>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046689.png" alt=""></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092046502.png" alt=""></p>
<p>几个参数：</p>
<p>① RssiPkt:上一包接收数据的平均RSSI信号强度，实际信号强度值为-RssiPkt/2.单位为dBm。</p>
<p>② SnrPkt:以二进制补码格式，接收的上一包数据的SNR估计值乘以4.实际值为 SnrPkt /4. 单位为dB。</p>
<p>③ SignalRssiPkt：接收的上一包数据解扩频后RSSI的估计值，实际值为-  SignalRssiPkt /2.单位为dBm.</p>
<p><strong>SX1262官方例程中有该函数的实现：</strong></p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092048034.png" alt=""></p>
<blockquote>
<p><strong>dBm与dB的区别</strong> ：</p>
<p>$dB$是一个表征相对值的值，纯粹的比值，只表示两个量的相对大小关系，没有单位，当考虑甲的功率相比于乙功率大或小多少个$dB$时，按下面的计算公式：10log(甲功率/乙功率)。例如甲功率比乙功率大一倍，那么$10lg(甲功率/乙功率)=10lg2=3dB$。</p>
<p>$dBm$是一个表示功率绝对值的值(也可以认为是以1$mW$功率为基准的一个比值)，计算公式为：$10log(功率值/1mw)$。例如功率P为$1mw$，折算为$dBm$后为$0dBm$。</p>
</blockquote>
<blockquote>
<p><strong>Semtech FAE给出的说明</strong> ：</p>
<p><font color=#FF0000><strong>在不考虑Cable Loss的情况下，</strong></font></p>
<p><font color=#FF0000><strong>当SNR &gt; 0时，RssiPkt即为Packet RSSI；</strong></font></p>
<p><font color=#FF0000><strong>当SNR &lt; 0时，信号是在噪声以下传输，所以Packet RSSI = SignalRssiPkt（即Current_RSSI） + SNR</strong></font>；</p>
</blockquote>
<p>不同的带宽BW有不同的底噪，如下表：（LLCC68）</p>
<table>
<thead>
<tr>
<th style="text-align:center">带宽（KHz）</th>
<th style="text-align:center">RSSI(dBm)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">125</td>
<td style="text-align:center">-114~-115</td>
</tr>
<tr>
<td style="text-align:center">250</td>
<td style="text-align:center">-111~-112</td>
</tr>
<tr>
<td style="text-align:center">500</td>
<td style="text-align:center">-107~-108</td>
</tr>
</tbody>
</table>
<p>接收端所需的最小信噪比阈值见下表，小于该值后，芯片不能有效的解调出信号。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092054205.png" alt=""></p>
<h4 id="7-发送单载波">7.发送单载波</h4>
<h5 id="SetTxContinuousWave">SetTxContinuousWave</h5>
<p>该条命令一般在CE、FCC等认证或者生产测试时使用，作为发送单载波或功率的一种手段。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092116441.png"  style="zoom: 50%;" />
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_SetTxContinuousWave</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_SET_TXCONTINUOUSWAVE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h4 id="8-中断状态相关操作">8.中断状态相关操作</h4>
<h5 id="SetDioIrqParams">SetDioIrqParams</h5>
<p>将中断事件绑定至DIOx引脚，作为输出中断源。</p>
<p><img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092135929.png" alt="">源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_SetDioIrqParams</span><span class="token punctuation">(</span>INT16U irqMask<span class="token punctuation">,</span>INT16U dio1Mask<span class="token punctuation">,</span>INT16U dio2Mask<span class="token punctuation">,</span>INT16U dio3Mask<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>irqMask <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>irqMask <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dio1Mask <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>dio1Mask <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dio2Mask <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>dio2Mask <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dio3Mask <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span>dio3Mask <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_CFG_DIOIRQ<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>相关中断事件：</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092138347.png"  style="zoom:50%;" />
<h5 id="GetIrqStatus">GetIrqStatus</h5>
<p>获取当前设备中断状态。</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092132496.png"  style="zoom:50%;" />
<p>源码实现如下：</p>
<pre class="language-c" data-language="c"><code class="language-c">INT16U <span class="token function">SX126X_GetIrqStatus</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U irqStatus<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_ReadCommand</span><span class="token punctuation">(</span>RADIO_GET_IRQSTATUS<span class="token punctuation">,</span> irqStatus<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>irqStatus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> irqStatus<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h5 id="ClearIrqStatus">ClearIrqStatus</h5>
<p>清除指定中断标志</p>
<img data-src="https://hyh1370039199-1313349927.cos.ap-chengdu.myqcloud.com/img/202210092134284.png"  style="zoom:50%;" />
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">SX126X_ClearIrqStatus</span><span class="token punctuation">(</span>INT16U irq<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    INT8U buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>INT16U<span class="token punctuation">)</span>irq <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>INT8U<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>INT16U<span class="token punctuation">)</span>irq <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SX126X_WriteCommand</span><span class="token punctuation">(</span>RADIO_CLR_IRQSTATUS<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="八、认证相关调试经验">八、认证相关调试经验</h3>
<p>1.若认证机构在测试功率谱密度指标时未通过时，可以尝试调用<code>SetTxContinuousWave</code>、<code>SetTxInfinitePreamble</code>函数，以及对SF、BW等调制参数进行逐个尝试。</p>
<blockquote>
<p>无线通信产品在其的工作频段中，每单位频点所携带的能量（功率）我们称为功率谱密度（power spectral density, PSD）。一般来说这个能量是不固定的，会随着产品带宽的不同功率也就不同，在各国针对无线产品的标准中对功率谱密度都有一定的限制值。因此功率谱密度测试在射频测试中是一个基础测试项目。</p>
</blockquote>
<p>2.常见认证(如CE、FCC认证等)一般要求14dBm以下，对于30dBm大功率模组，一般需将功率下降至0dBm功率以下才可以通过。</p>
<p>3.关于CE认证中-6dB带宽，如果认证要求趋近于射频芯片的调制带宽（例如BW125),可以通过SF扩频因子来调节，SF越小，-6dB带宽越小。</p>
<p>4.对于认证对传输时间做相关要求时，可以通过调整芯片内部PA的斜坡时间，以及SF、BW等调制参数进行调试。</p>
<h3 id="九、总结">九、总结</h3>
<p>以上就是结合SX1262数据手册以及在开发时遇到的一些问题及调试时的一些经验，对自己学习的记录，虽然主要叙述的是SX1261/2，但LoRa芯片基本框架还是一致的，使用其他LoRa芯片时也可以参考一下，若文中有出错之处，望指正！</p>

    </div>

    
    
    

    <footer class="post-footer">








<div class="license">
  <div class="license-title">SX1261/2芯片学习笔记</div>
  <div class="license-link">
    <a href="https://hyh.cool/post/18/">https://hyh.cool/post/18/</a>
  </div>
  <div class="license-meta">
    <div class="license-meta-item">
      <div class="license-meta-title">本文作者</div>
      <div class="license-meta-text">
          hyh
      </div>
    </div>
      <div class="license-meta-item">
        <div class="license-meta-title">发布于</div>
        <div class="license-meta-text">
          2022-10-09
        </div>
      </div>
      <div class="license-meta-item">
        <div class="license-meta-title">更新于</div>
        <div class="license-meta-text">
          2022-10-14
        </div>
      </div>
    <div class="license-meta-item">
      <div class="license-meta-title">许可协议</div>
      <div class="license-meta-text">
          <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank">CC BY-NC-SA 4.0</a>
        
      </div>
    </div>
  </div>
  <div class="license-statement">
      转载或引用本文时，请遵守上述许可协议，注明出处、不得用于商业用途！
    
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%B0%84%E9%A2%91%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tag"></i> 射频开发</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/20/" rel="prev" title="硬件设计学习笔记-阻抗匹配">
                  <i class="fa fa-chevron-left"></i> 硬件设计学习笔记-阻抗匹配
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/17/" rel="next" title="《拖延心理学》读书笔记">
                  《拖延心理学》读书笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner" style="width:100%">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fas fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hyh</span>
</div><!--添加运行时间-->
<span id="sitetime"></span>
<script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* 
      Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
      year - 作为date对象的年份，为4位年份值
      month - 0-11之间的整数，做为date对象的月份
      day - 1-31之间的整数，做为date对象的天数
      hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
      minutes - 0-59之间的整数，做为date对象的分钟数
      seconds - 0-59之间的整数，做为date对象的秒数
      microseconds - 0-999之间的整数，做为date对象的毫秒数
     */
		var t1 = Date.UTC(2022,06,01,00,00,00); //北京时间2018-2-13 00:00:00
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		document.getElementById("sitetime").innerHTML=" 本站已安全运行"+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
	}
	siteTime();
</script>
<!--// 添加运行时间-->
<div class="powered">  
    该主题由<a href="https://dlzhang.com" rel="noopener" target="_blank">班班</a>使用 <a href="https://theme-next.js.org" rel="noopener" target="_blank">NexT</a> 主题设计
    <br>
    <a href="/tags/">文章标签</a> · <a href="/policy/">网站政策</a>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.staticfile.org/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.staticfile.org/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.staticfile.org/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/comments.min.js"></script><script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/utils.min.js"></script><script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/next-boot.min.js"></script><script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/pjax.min.js"></script>

  
<script src="https://cdn.staticfile.org/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/third-party/search/local-search.min.js"></script>



  <script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/third-party/fancybox.min.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/third-party/math/mathjax.min.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"1370039199/blog-utterances","issue_term":"pathname","theme":"github-dark"}</script>
<script src="https://cdn.staticfile.org/hexo-theme-next/8.12.3/third-party/comments/utterances.min.js"></script>



<script data-pjax type="text/javascript">
  //jquery selector
  var $linkList = $(".link-list");
  if ($linkList.length != 0) {
    var j = -1;
    for	(var i = 0; i < $linkList.length; i++) {
      const listPath = $linkList[i].getAttribute('json-src');
      const iconPath = $linkList[i].getAttribute('icon-src');
      //使用 getJSON 读取 JSON 文件中的数据
      $.getJSON(listPath, function(data) {
        j++;
        //存储数据的变量 
        var li = "";
        //清空内容 
        $linkList.eq(j).empty();
        //将获取到的 json 格式数据遍历到 div 中
        $.each(data, function(infoIndex, info) {
          var labelWarn = '';
          var labelInfo = '';
          if (info['warn']) { 
            labelWarn = '<span class="label warn">' + info['warn'] + '</span>';
          }
          if (info['info']) { 
            labelInfo = '<span class="label info">' + info['info'] + '</span>';
          }
          li += '<div class="link-list-container">';
          li += '<img class="link-list-image" src="' + iconPath + info['logo'] + '">';
          li += '<p>' + info['title'] + labelInfo + labelWarn + '</p>';
          li += '<p>' + info['intro'] + '</p>';
          li += '<a href="' + info['url'] + '" rel="noopener" target="_blank" data-pjax-state=""></a>';
          li += '</div>';
        })
        //显示处理后的数据 
        $linkList.eq(j).html(li);
      })
    }
  }
</script>



<script data-pjax type="text/javascript">
  //jquery selector
  var $cultureList = $(".culture-list");
  if ($cultureList.length != 0) {
    var j = -1;
    for	(var i = 0; i < $cultureList.length; i++) {
      const listPath = $cultureList[i].getAttribute('json-src');
      const coverPath = $cultureList[i].getAttribute('cover-src');
      //使用 getJSON 读取 JSON 文件中的数据
      $.getJSON(listPath, function(data) {
        j++;
        //存储数据的变量 
        var li = "";
        //清空内容 
        $cultureList.eq(j).empty();
        //将获取到的 json 格式数据遍历到 div 中
        $.each(data, function(infoIndex, info) {
          //影评书评链接
          var title = info['title'];
          if (info['pid']) {
            title = '<a href="/post/'+ info['pid'] +'/" >' + info['title'] +'</a>';
          }

          //作者
          if (info['author']) {
            var author = '<span class="author">' + info['author'] +'</span>';
          } else {
            var author = '';
          }

          //简介
          if (info['intro']) {
            var intro = info['intro'];
          } else {
            var intro = '';
          }
          
          //分数
          if (info['score'] == null) {
            var star = '';
          } else {
            //初始化
            var colorStar = '';
            var greyStar = '';
            var int = info['score'] - info['score'] % 1; //整数部分
            //是否有小数
            var fract = 0; 
            if (info['score'] % 1 != 0) {
              fract = 1;
            }
            //整数星级
            for	(var m = 0; m < int; m++) {
              colorStar += '★';
            }
            //半星级
            if (fract != 0) {
              colorStar += '☆';
            }
            //用空缺星补齐五星
            for	(var m = 0; m < (5 - fract - int); m++) {
              greyStar += '☆';
            }
            if (info['score'] != 5) {
              star = '<span class="star-score">'+ colorStar +'<span class="grey-star">'+ greyStar +'</span></span>';
            } else {
              star = '<span class="star-score">'+ colorStar +'</span>';
            }
          }

          li += '<div class="media">';
          li += '<div class="media-cover" style="background-image:url(' + coverPath + info['cover'] + ')"></div>';
          li += '<div class="media-meta">';
          li += '<div class="media-meta-item title">' + title + '</div>';
          li += '<div class="media-meta-item">' + author + star +'</div>';
          li += '<div class="media-meta-item intro">' + intro + '</div>';
          li += '</div></div>';
        })
        
        //显示处理后的数据 
        $cultureList.eq(j).html(li);
      })
    }
  }
</script>




<script src="/resources/minigrid.min.js"></script>
<script data-pjax type="text/javascript">
  var $album = $(".album")[0];
  if($album) {
    // 相册列表 JSON 数据
    var imgDataPath = $album.getAttribute('json-src');
    // 照片存储路径
    var imgPath = $album.getAttribute('photo-src');
    // 最多显示数量
    var imgMaxNum = 50;
    // 获取窗口大小以决定图片宽度
    var windowWidth = window.innerWidth
    || document.documentElement.clientWidth
    || document.body.clientWidth;
    if (windowWidth < 768) {
        var imageWidth = 145; // 移动端图片宽度
    } else {
        var imageWidth = 235;
    }

    // 腾讯云自定义样式 (数据万象外网流量需要付费)
    //var imgStyle = '!' + imageWidth + 'x';
    //var imgStyle = '!300x';

    // 生成相册
    var LinkDataPath = imgDataPath;
    photo = {
        page: 1,
        offset: imgMaxNum,
        init: function () {
            var that = this;
            $.getJSON(LinkDataPath, function (data) {
                that.render(that.page, data);
            });
        },
        render: function (page, data) {
            var begin = (page - 1) * this.offset;
            var end = page * this.offset;
            if (begin >= data.length) return;
            var imgNameWithPattern, imgName, imageSize, imageX, imageY, li = "";
            for (var i = begin; i < end && i < data.length; i++) {
                imgNameWithPattern = data[i].split(' ')[1];
                imgName = imgNameWithPattern.split('.')[0]
                imageSize = data[i].split(' ')[0];
                imageX = imageSize.split('.')[0];
                imageY = imageSize.split('.')[1];
                li += '<div class="card" style="width:' + imageWidth + 'px" >'
                li += '<div class="album-photo" style="height:'+ imageWidth * imageY / imageX + 'px">'
                li += '<a class="fancybox fancybox.image" href="' + imgPath + imgNameWithPattern + '" itemscope="" itemtype="http://schema.org/ImageObject" itemprop="url" data-fancybox="group" rel="group" data-caption="' + imgName + '" title="' +  imgName + '">'
                li += '<img data-src="' + imgPath + imgNameWithPattern + '" src="' + imgPath + imgNameWithPattern + '" alt="' +  imgName + '" data-loaded="true">'
                li += '</a>'
                li += '</div>'
                li += '</div>'
            }
            $(".album").append(li);
            this.minigrid();
        },

        minigrid: function() {
          var grid = new Minigrid({
              container: '.album',
              item: '.card',
              gutter: 12
          });
          grid.mount();
          $(window).resize(function() {
              grid.mount();
          });
        }
    }
    photo.init();
  }
</script>
</body>
</html>
